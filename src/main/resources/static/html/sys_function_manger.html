<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>系统功能管理</title>
<script type="text/javascript" src="../boot.js"></script>
</head>

<body>
	<div class="mini-splitter" style="width:100%;height:600px;">
    <div size="20%" showCollapseButton="true">
        <div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">                
            <span style="padding-left:5px;">菜单列表</span>
        </div>
        <div class="mini-fit">
            <ul id="tree1" class="mini-tree" style="width:100%;"
                showTreeIcon="true" textField="functionName" idField="functionId" parentField="parentFunctionId" resultAsTree="false"  
            	nodeClick="nodedblclick" expandOnLoad="true"
            >        
            </ul>
        </div>
    </div>
    <div showCollapseButton="true">
        
        <div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">                
             <a class="mini-button" iconCls="icon-add" plain="true" onclick="newFunction">新增</a>
             <a class="mini-button" iconCls="icon-remove" plain="true" onclick="delFunction">删除</a>   
        </div>
        <div class="mini-fit">
        <!-- 表单 -->
	         <fieldset id="editForm1" style="width: 100%"  >
	             <legend><span>基本信息</span></legend>
	             <input  id="parentLevelCode"  name="parentLevelCode" class="mini-textbox"  style="display: none"/>
	             <table style="width:100%;">
	             
	             	<tr>
	                    <td style="width:80px;">功能ID：</td>
	                    <td style="width:150px;"><input id="functionId" name="functionId" class="mini-textbox"  readonly="readonly"/></td>
	                    <td style="width:80px;">父节点ID：</td>
	                    <td style="width:150px;"><input id="parentFunctionId" name="parentFunctionId" class="mini-textbox" readonly="readonly" /></td>
	                </tr>
	                
	                <tr>
	                    <td style="width:80px;">功能名称：</td>
	                    <td style="width:150px;"><input id="functionName" name="functionName" class="mini-textbox" /></td>
	                    <td style="width:80px;">功能编号：</td>
	                    <td style="width:150px;"><input id="functionCode" name="functionCode" class="mini-textbox" /></td>
	                </tr>
	                
	                <tr>
	                    <td style="width:80px;">URL：</td>
	                    <td style="width:150px;"><input id="url" name="url" class="mini-textbox" /></td>
	                    <td style="width:80px;">功能分类：</td>
	                    <td style="width:150px;"><input id="functionType" name="functionType" class="mini-combobox"  textField="enumName" valueField="enumCode" showNullItem="false"/></td>
	                </tr>
	                
	                <tr>
	                    <td style="width:80px;">适用范围：</td>
	                    <td style="width:150px;"><input id="functionScope" name="functionScope" class="mini-combobox"  textField="enumName" valueField="enumCode" showNullItem="false"/></td>
	                    <td style="width:80px;">
	                        <div id="status" name="status" class="mini-checkbox"  trueValue="1" falseValue="0" checked="true" readOnly="false" text="是否启用" ></div>
	                    </td>
	                    <td style="width:150px;">
	                    	<div id="logFlag" name="logFlag" class="mini-checkbox" trueValue="1" falseValue="0" checked="false" readOnly="false" text="是否记录日志" ></div>
	                    </td>
	                </tr>
	                <tr>
	                	<td style="width:80px;">图标：</td>
	                    <td style="width:150px;"  >
	                    	<textarea style="width: 80%" id="icon" name="icon" class="mini-textarea" emptyText="请输入备注"></textarea>
	                    </td>
	                    <td style="width:80px;">描述：</td>
	                    <td >
							<textarea style="width: 80%" id="remark" name="remark" class="mini-textarea" emptyText="请输入备注"></textarea>
	                    </td>
	                </tr>
	                <tr>
	                    <td  text-align: center;" colspan="4">
	                        <a id=“saveFunction”  onclick="saveFunction" class="mini-button mini-button-primary" iconCls="icon-save" plain="true">保存</a>
	                    </td>
	                </tr>
	           	 </table>
	        </fieldset>
	        
	        <fieldset id="editForm2" style="width: 100%;height: 400px"  >
	        	<legend><span>API 依赖关系</span></legend>
	        	
	        	<iframe  id="funcApiFrame"  style="width: 100%;height: 100%" src="" ></iframe>

	        </fieldset>
	        
        </div>
        
    </div>        
</div>

</body>
<script type="text/javascript">
mini.parse();
var tree = mini.get("tree1");
var grid = mini.get("grid1");
var editForm1 = new mini.Form("#editForm1");


$(function() {
	init();
	refalshTree();
	//alert("ok");
   
   //2 选择节点时发生
   tree.on("nodeselect", function (e) {
       editForm1.setData(e.node);
	   $("#funcApiFrame").attr("src","selectApi.html?Id="+e.node.functionId);
   });
  
   //3. 绑定保存数据
   
   
});


var init = function(){
	
	$.get("/ems/sysDictionary/getDictionaryByType?type=function_type",null,function(data){
	   var funList = data.value;
	   mini.get("functionType").setData(funList);
    });
	
	$.get("/ems/sysDictionary/getDictionaryByType?type=function_scope",null,function(data){
	   var funList = data.value;
	   mini.get("functionScope").setData(funList);
    });
}
/****
 * 刷新树
 */
var refalshTree = function(){
	 // 1. 加载菜单数据
   $.get("/auth/sysFunction/syncSysFunctionList",null,function(data){
	   var funList = data.value;
	   tree.loadList(funList, "functionId", "parentFunctionId");
   });
};


// 提交保存
var saveFunction= function(){
	
	var node = tree.getSelectedNode();
	if(!node){
		mini.alert("请选择节点操作");
		return;
	}
	 var data = editForm1.getData();
	 $.ajax({
         url: "/auth/sysFunction/modSysFunction",
         type: "post",
         data: mini.encode(data),
         dataType:"json",  
         contentType:"application/json;charset=utf-8",
         success: function (data) {
             if(data.success){
            	 mini.alert("保存操作成功");
            	 refalshTree();
             }else{
            	 mini.alert("保存操作失败");
             }
         }
     });
}
/***
 * 新增一个菜单
 */
var newFunction = function (){
	var node = tree.getSelectedNode();
	if(!node){
		mini.alert("请选择节点操作");
		return;
	}
	editForm1.reset();
	var dataInit = {parentFunctionId:node.functionId,parentLevelCode:node.treeLevelCode};
	editForm1.setData(dataInit);
	$("#funcApiFrame").attr("src","");

}


/***
 * 新增一个菜单
 */
var delFunction = function (){
	var node = tree.getSelectedNode();
	if(!node){
		mini.alert("请选择节点操作");
		return;
	}
	editForm1.reset();
	$.post("/auth/sysFunction/delSysFunction",{functionId:node.functionId},function(data){
		if(data.success){
       	 mini.alert("删除操作成功");
       	 refalshTree();
        }else{
       	 mini.alert("删除操作失败");
        }
    });

}


</script>

</html>